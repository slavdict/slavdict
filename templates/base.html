<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>{{ title }}</title>
        <link href="{{ STATIC_URL }}style.css" rel="stylesheet" type="text/css">
        <link href="{{ STATIC_URL }}singlecomplete.css" rel="stylesheet" type="text/css">
    </head>
    <body data-bind="event: { keydown: function(event){ if (event.which == 27) vM_hdrSearch.flushItems(); return true; } }">
        <noscript>Для правильной работы данной лексикографической системы необходимо, чтобы у Вас были включены скрипты.</noscript>

        {% block header_0 %}
        <div class="header">
            {% block header %}

                <a href="{% url my_entries_url %}" class="header--item">Мои статьи</a>
                <a href="{% url all_entries_url %}" class="header--item">Все статьи</a>

                {% if user.is_admeditor %}
                    <a href="{% url admin:dictionary_entry_add %}" class="header--item">+</a>
                {% endif %}

                <form class="searchForm" enctype="application/x-www-form-urlencoded" action="{% url all_entries_url %}">
                    <input type="text" name="find" value="{{ find_prefix }}"
                       class="header--item-left header--item-block search"
                       data-bind="
                            value: searchPrefix,
                            valueUpdate: 'afterkeydown',
                            event: { keydown: navigateFoundItems, blur: flushItems }"
                       autocomplete="off"
                       spellcheck="false"
                    /><span class="header--item-right button"
                            data-bind="click: function(){ $('form.searchForm').submit(); }">Найти</span>

                    <ul class="foundItems" data-bind="foreach: foundItems, css: { hidden: foundItems().length == 0 }">
                        <li class="SC--foundItem"
                            data-bind="css: { 'SC--foundItem-focused': isFocused },
                                       event: {
                                            mousedown: function(){ $parent.go($data); },
                                            mouseover: function(){ $data.focusMe(); }
                                       }">
                            <span class="SC--fI--headword" data-bind="text: headword"></span>
                            <span class="SC--fI--homonym" data-bind="text: hom"></span>
                            <span class="SC--fI--pOS" data-bind="text: pos"></span>
                            <span class="SC--fI--hint" data-bind="text: hint"></span>
                        </li>
                    </ul>
                </form>

                <a href="{% url converter %}" class="header--item">Конвертър</a>

                {% if user.is_admeditor or user.is_hellinist %}
                    <a href="{% url hellinist_workbench %}" class="header--item">Греческий кабинет</a>
                {% endif %}

            {% endblock %}
        </div>
        {% endblock %}

        <div id="main">
            {% block content %}{% endblock %}
        </div>

        <script type='text/javascript' src='{{ STATIC_URL }}jquery-1.6.4.min.js'></script>
        <script type='text/javascript' src='{{ STATIC_URL }}knockout-latest.debug.js'></script>
        <script>

            function Item(item, focused) {

                this.headword = item.headword;
                this.hom = item.hom || '';
                this.pos = item.pos || '';
                this.hint = item.hint || '';
                this.url = item.url;

                this.focusMe = function(){
                    focused(this);
                }.bind(this);

                this.isFocused = ko.dependentObservable(
                    function(){ return focused() === this; },
                    this
                );
            }

            var vM_hdrSearch = {
                searchPrefix: ko.observable(),
                foundItems: ko.observableArray(),
                focusedItem: ko.observable()
            };

            vM_hdrSearch.moveFocusDown = function() {
                var items = this.foundItems();
                var arrLength = items.length;
                var currentItem = this.focusedItem();
                var index = 0;
                if (currentItem) {
                    index = ko.utils.arrayIndexOf(items, currentItem);
                    index = index > (arrLength - 2) ? 0 : ++index;
                }
                items[index].focusMe();
            }.bind(vM_hdrSearch);

            vM_hdrSearch.moveFocusUp = function() {
                var items = this.foundItems();
                var arrLength = items.length;
                var currentItem = this.focusedItem();
                var index = arrLength - 1;
                if (currentItem) {
                    index = ko.utils.arrayIndexOf(items, currentItem);
                    index = index < 1 ? arrLength - 1 : --index;
                }
                items[index].focusMe();
            }.bind(vM_hdrSearch);

            vM_hdrSearch.go = function(item) {
                window.location.href = item.url;
            };

            vM_hdrSearch.flushItems = function() { this.foundItems.splice(0); }.bind(vM_hdrSearch);

            vM_hdrSearch.navigateFoundItems = function(event) {
                if (event.which == 40) { // down arrow key
                    this.moveFocusDown();
                } else if (event.which == 38) { // up arrow key
                    this.moveFocusUp();
                } else if (event.which == 13) { // enter key
                    if (this.focusedItem()) this.go(this.focusedItem());
                    else $('.header form').submit();
                } else if (event.which == 27) { // esc key
                    this.foundItems.splice(0);
                } else {
                    return true;
                }
            }.bind(vM_hdrSearch);

            vM_hdrSearch.searchPrefix.subscribe(function(newValue) {
                if (newValue) {
                    var dataToSend = { find: newValue };
                    if (this.lastItemsRequest) { this.lastItemsRequest.abort(); }
                    this.lastItemsRequest = $.getJSON(
                        "/json/singleselect/entries/urls/",
                        dataToSend,
                        function(data){
                            var mappedData = ko.utils.arrayMap(
                                data,
                                function(item){ return new Item(item, vM_hdrSearch.focusedItem); }
                            );
                            vM_hdrSearch.foundItems(mappedData);
                            if (vM_hdrSearch.foundItems().length==1) {
                                vM_hdrSearch.foundItems()[0].focusMe();
                            }
                        }
                    );
                } else {
                    this.flushItems();
                }
            }, vM_hdrSearch);

            ko.applyBindings(vM_hdrSearch);
        </script>

        {% block javascript %}{% endblock %}

    </body>
</html>
