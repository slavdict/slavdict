{% from 'indesign/etymology.xml'   import etymology    with context %}
{% from 'indesign/meaning_without_children.xml' import meaning with context %}

<entry>
    <p aid:pstyle="FirstParagraph" aid:cstyle="Text">

    {% for base_var in entry.base_vars %}
        {% if loop.first %}
            {# pass #}
        {% elif loop.last %}
            {{ backspace }}{{ nbsp }}
            <i aid:cstyle="Em">и</i>{{ space }}
        {% else %}
            {{ backspace }}<text aid:cstyle="Text">,</text>{{ space }}
        {% endif %}

        <headword aid:cstyle="{% if loop.first %}Headword{% else %}SubHeadword{% endif %}">
            {{ base_var.idem_ucs|e }}
        </headword>
        {% if loop.first %}
            {% if entry.homonym_order %}
                <homonym-number aid:cstyle="HeadwordHomonymNumber">
                    {{ entry.homonym_order }}
                </homonym-number>
                {{ space }}
            {% endif %}
            {% if entry.questionable_headword %}
                <questionable>(?)</questionable>
            {% endif %}
        {% endif %}
        {{ backspace }}{{ space }}

        {% for var in base_var.childvars %}

            {% if loop.first %}
                <text aid:cstyle="Text">(</text>
            {% endif %}

            <var aid:cstyle="CSLSegment">
                {{ var.idem_ucs|e }}
            </var>

            {% if loop.last %}
                {{ backspace }}<text aid:cstyle="Text">)</text>{{ space }}
            {% else %}
                {{ backspace }}<text aid:cstyle="Text">,</text>{{ space }}
            {% endif %}

        {% endfor %}

    {% endfor %}


    {% if entry.short_form or entry.genitive or entry.sg1 or entry.sg2 %}
        {{ backspace }}<text aid:cstyle="Text">,</text>{{ space }}
    {% endif %}


    {% if entry.short_form %}
        {% if entry.short_form_ucs_wax.0 %}
            <x aid:cstyle="Text">{{ nbhyphen }}</x>
        {% endif %}
        <x>{{ entry.short_form_ucs_wax.1|ind_cslav_words("CSLSegment") }}</x>
        {% if entry.short_form|has_no_accent %}
            {% include 'indesign/noaccent.xml' %}
        {% endif %}
        {{ space }}
    {% endif %}

    {% if entry.genitive %}
        {% if entry.genitive_ucs_wax.0 %}
            <x aid:cstyle="Text">{{ nbhyphen }}</x>
        {% endif %}
        <x>{{ entry.genitive_ucs_wax.1|ind_cslav_words("CSLSegment") }}</x>
        {% if entry.genitive|has_no_accent %}
            {% include 'indesign/noaccent.xml' %}
        {% endif %}
        {{ space }}
    {% endif %}

    {% if entry.sg1 %}
        {% if entry.sg1_ucs_wax.0 %}
            <x aid:cstyle="Text">{{ nbhyphen }}</x>
        {% endif %}
        <x>{{ entry.sg1_ucs_wax.1|ind_cslav_words("CSLSegment") }}</x>
        {% if entry.sg1|has_no_accent %}
            {% include 'indesign/noaccent.xml' %}
        {% endif %}
        {% if entry.sg2 %}
            <x aid:cstyle="Text">,</x>
        {%endif %}
        {{ space }}
    {% endif %}

    {% if entry.sg2 %}
        {% if entry.sg2_ucs_wax.0 %}
            <x aid:cstyle="Text">{{ nbhyphen }}</x>
        {% endif %}
        <x>{{ entry.sg2_ucs_wax.1|ind_cslav_words("CSLSegment") }}</x>
        {% if entry.sg2|has_no_accent %}
            {% include 'indesign/noaccent.xml' %}
        {% endif %}
        {{ space }}
    {% endif %}

    {% if entry.uninflected %}
        <x aid:cstyle="Em">
            неизм.
        </x>
        {{ space }}
    {% endif %}

    {% if entry.possessive %}
        <x aid:cstyle="Em">
            притяж.
        </x>
        {{ space }}
    {% endif %}


    {% if entry.participle_type %}
        <x aid:cstyle="Em">
            {{ entry.get_participle_type_display() }}
        </x>
        {{ space }}
    {% else %}
        {% if entry.part_of_speech %}
            {% if not entry.is_part_of_speech("letter") and
                  not entry.is_part_of_speech("number") and
                  not entry.is_part_of_speech("verb") and
                  not entry.is_part_of_speech("noun") %}
                <x aid:cstyle="Em">
                    {{ entry.get_part_of_speech_display() }}
                </x>
            {% endif %}
        {% endif %}

        {{ backspace }}{{ space }}
        {% if entry.gender %}
            <x aid:cstyle="Em">
                {{ entry.get_gender_display() }}
            </x>
            {{ space }}
        {% endif %}

        {% if entry.is_part_of_speech("verb") %}
            {{ backspace }}{{ space }}
            <x aid:cstyle="Em">
                {{ entry.transitivity_from_meanings }}
            </x>
            {{ space }}
        {% endif %}
    {% endif %}


    {% if entry.tantum %}
        {{ backspace }}{{ space }}
        <x aid:cstyle="Em">
            {{ entry.get_tantum_display() }}
        </x>
        {{ space }}
    {% endif %}

    {% if entry.is_onym('ethnonym') and entry.nom_sg %}
        {{ backspace }},{{ space }}
        <x aid:cstyle="Em">
            мн.
        </x>
        {{ space }}
        {% set several_ethnonyms = entry.special_cases('several ethnonyms') %}
        {% if several_ethnonyms %}
            {% for ethnonym, ethnonym_ucs in several_ethnonyms %}
                {% if not loop.first and not loop.last %}
                    {{ backspace }}<x aid:cstyle="Text">,</x>{{ space }}
                {% elif not loop.first and loop.last %}
                    {{ backspace }}{{ space }}<x aid:cstyle="Em">или</x>{{ space }}
                {% endif %}
                <x>{{ ethnonym_ucs|ind_cslav_words("CSLSegment") }}</x>
                {% if ethnonym|has_no_accent %}
                    {% include 'indesign/noaccent.xml' %}
                {% endif %}
                {{ space }}
            {% endfor %}
        {% else %}
            {% if entry.nom_sg_ucs_wax.0 %}
                {{ backspace }}{{ space }}{{ nbhyphen }}
            {%endif %}
            <x>{{ entry.nom_sg_ucs_wax.1|ind_cslav_words("CSLSegment") }}</x>
            {% if entry.nom_sg|has_no_accent %}
                {% include 'indesign/noaccent.xml' %}
            {% endif %}
            {{ space }}
        {% endif %}
    {% endif %}


    {% for etym in entry.etymologies %}

        {% set prevLang = Lang %}
        {% set Lang = etym.get_language_display() %}
        {% set isLanguageChanged = (Lang != prevLang) %}

        {{ etymology(etym, isLanguageChanged, loop) }}

    {% endfor %}


    {% if entry.is_onym('anthroponym') %}
        <i aid:cstyle="Em">
            имя собств.
        </i>
        {% if entry.canonical_name %}
            {{ backspace }}<text aid:cstyle="Text">,</text>{{ space }}
            <i aid:cstyle="Em">
                канонич.
            </i>
        {% endif %}
        {{ space }}
    {% endif %}

    {% if entry.is_onym('toponym') %}
        <i aid:cstyle="Em">
            топоним
        </i>{{ space }}
    {% endif %}


    {% for m in entry.meanings %}
        {% set mnumber = loop.index %}

        {% if not loop.first %}
            {{ backspace }}</p>{{ newline }}<p aid:pstyle="MeaningParagraph" aid:cstyle="Text">
        {% endif %}

        {% if entry.meanings|length > 1 %}
        <meaning-number aid:cstyle="MeaningNumber">
            {{ mnumber }}.
        </meaning-number>{{ nbsp }}
        {% endif %}

        {% include 'indesign/meaning_with_children.xml' with context %}
        {% include 'indesign/meaning_collogroups.xml' with context %}
    {% endfor %}


    {% if entry.cfentries or entry.cfcollogroups %}
        {{ backspace }}</p>{{ newline }}
        <p aid:pstyle="CfParagraph" aid:cstyle="Text"><i aid:cstyle="Em">
            Ср.
        </i>{{ nbsp }}

        {% for cfe in entry.cfentries %}

            {% if not loop.first %}
                {{ backspace }}<text aid:cstyle="Text">,</text>{{ space }}
            {% endif %}

            {{ cfe.orth_vars.0.idem_ucs|ind_cslav_words("CSLSegment") }}

            {% if cfe.homonym_order %}
                <homonym-number aid:cstyle="HeadwordNumber">
                    {{ cfe.homonym_order }}
                </homonym-number>
            {% endif %}
        {% endfor %}

        {% for cfcg in entry.cfcollogroups %}
            {% if not loop.first or entry.cfentries %}
                {{ backspace }}<text aid:cstyle="Text">,</text>{{ space }}
            {% endif %}
            {{ cfcg.collocations.0.collocation_ucs|ind_cslav_words("CSLSegment") }}
        {% endfor %}
        {{ backspace }}<text aid:cstyle="Text">.</text>
    {% endif %}

    {{ backspace }}</p>
</entry>

{# vim: set ft=django.xml: #}
