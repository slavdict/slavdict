{% extends 'base.html' %}

{% set sort = form['sortdir'].value() + form['sortbase'].value() %}
{% set filters = form.cleaned_data %}

{% block subheader %}

    <div class="filters">
        <div class="f5s--statusbar">
            <span data-bind="visible: author() != 'all'">
                <span data-bind="text: author.obj().name"></span>
            </span>
            <span data-bind="visible: find()">
                на
                <span data-bind="text: find"></span>
            </span>
            <span data-bind="visible: status() != 'all'">
                <span data-bind="text: status.obj().name"></span>
            </span>
        </div>
        <div class="f5s--dashboard">

            <div class="f5sD--sort">
            <h3>Упорядочить статьи</h3>

                {{ form.sortdir }} на основе {{ form.sortbase }}

            </div>

            <div class="f5sD--filter">
            <h3>Отобрать статьи по следующим критериям</h3>

                {{ form.find.label_tag() }}
                {{ form.find }}

                {{ form.author.label_tag() }}
                {{ form.author }}

                {{ form.status.label_tag() }}
                {{ form.status }}

                {{ form.pos.label_tag() }}
                {{ form.pos }}

                {{ form.uninflected }}
                {{ form.uninflected.label_tag() }}

                {{ form.gender.label_tag() }}
                {{ form.gender }}

                {{ form.tantum.label_tag() }}
                {{ form.tantum }}

                {{ form.possessive.label_tag() }}
                {{ form.possessive }}

                {{ form.onym.label_tag() }}
                {{ form.onym }}

                {{ form.canonical_name.label_tag() }}
                {{ form.canonical_name }}

                {{ form.etymology }}
                {{ form.etymology.label_tag() }}

                {{ form.additional_info }}
                {{ form.additional_info.label_tag() }}

                {{ form.homonym }}
                {{ form.homonym.label_tag() }}

                {{ form.duplicate }}
                {{ form.duplicate.label_tag() }}
            </div>

            <input type="submit" value="применить"/>

        </div>
        <div class="f5s--advertiser">
            <span class="f5sA--label">фильтры</span>
        </div>
    </div>

{% endblock %}


{% block content %}

    {% if not entries %}
        <div class="message">
        {% if filters.find %}
            К сожалению, ни одной словарной статьи, начинающейся <span
            class="nowrap">с <b class="red caps">{{ filters.find.lower() }}...</b>, не найдено.</span>
            Пожалуйста, проверьте Ваш запрос на наличие опечаток или измените его
            в целях поиска другого слова. Поиск производится без учёта регистра символов.
        {% else %}{% if mine %}
            К сожалению, в базе данных пока не содержится ни одной словарной статьи, для которой Вы являетесь автором.
        {% else %}
            К сожалению, ни одной словарной статьи, удовлетворяющей Вашему запросу, не найдено.
        {% endif %}{% endif %}
        </div>
    {% endif %}

    {% trim %}
    {% if entries %}
        <table class="entry-list">
            <col class="eli-control" />
            <col class="eli-entry" />
            <col class="eli-author" />
            <col class="eli-mtime" />
            <col class="eli-status" />

            {% if entries|length > 1 %}
            <tr class="control-row">
                <td class="eli-control first"></td>
                <td class="eli-control"></td>
                <td class="eli-entry">
                    <span class="ssn anchor"
                          data-bind="css: { on: sort() === 'alph' },
                                   click: doSort.bind($data, 'alph')"
                          title="Упорядочить по возрастанию">↓</span>
                      <span class="ssn anchor"
                          data-bind="css: { on: sort() === '-alph' },
                                   click: doSort.bind($data, '-alph')"
                          title="Упорядочить по убыванию">↑</span>
                    <span class="ssn white">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;по алфавиту</span>
                </td>
                <td class="eli-author"></td>
                <td class="eli-mtime">
                    <span class="ssn anchor"
                          data-bind="css: { on: sort() === 't' },
                                   click: doSort.bind($data, 't')"
                          title="Упорядочить по возрастанию">↓</span>
                    <span class="ssn anchor"
                          data-bind="css: { on: sort() === '-t' },
                                   click: doSort.bind($data, '-t')"
                          title="Упорядочить по убыванию">↑</span>
                    <span class="ssn white">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;по вр. изм.</span>
                </td>
                <td class="eli-status"></td>
            </tr>
            {% endif %}

        {% for entry in entries %}
            <tr class="entry-list-item">

                <td class="eli-control first">

                    <div class="shade">
                        <div class="center"></div>
                        <div class="left"></div>
                        <div class="right"></div>
                    </div>

                    {% if not entry.editor or user.is_admeditor or user == entry.editor %}
                        {% if not entry.duplicate or user.is_admeditor %}
                        <a href="{% url intermediary_change_form_url entry.pk %}" class="icon edit">
                            <img src="{{ STATIC_URL }}transparent.png" alt="e" />
                        </a>
                        <span class="hint-container">
                            <div class="hint">Редактировать<br/>статью</div>
                        </span>
                        {% else %}&nbsp;{% endif %}
                    {% else %}
                        &nbsp;
                    {% endif %}
                </td>

                <td class="eli-control">
                    <a href="{{ entry.get_absolute_url() }}" class="icon view">
                        <img src="{{ STATIC_URL }}transparent.png" alt="v" />
                    </a>
                    <span class="hint-container">
                        <div class="hint">Просмотреть<br/>статью</div>
                    </span>
                </td>

                <td class="eli-entry">

                    <div class="fade">
                        <div>
                            <a href="{{ entry.get_absolute_url() }}" class="manual-entry">
                                 <span class="cslav">{{ entry.orth_vars.0.idem_ucs }}</span>
                                 {% if entry.homonym_order %}
                                     &nbsp;{{ entry.homonym_order_roman }}
                                 {% endif %}
                            </a>

                            {% if entry.duplicate %}
                                &nbsp;<span class="noaddress">дубликат</span>
                            {% endif %}

                            <span class="ss transparent">
                                &nbsp;&nbsp;&nbsp;
                                {% if entry.part_of_speech.slug != "letter" and entry.part_of_speech.slug != "number" %}
                                    <i>{{ entry.part_of_speech.tag }}</i>
                                {% endif %}
                                {% if entry.homonym_gloss %}
                                    {{ space }}
                                    <span class="caps" title="{{ entry.homonym_gloss }}">{{ entry.homonym_gloss }}</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>

                    <a href="{{ entry.get_absolute_url() }}" class="manual-entry invisible">
                        <span class="cslav">{{ entry.orth_vars.0.idem_ucs }}</span>
                {% if entry.homonym_order %}
                        &nbsp;{{ entry.homonym_order_roman }}
                    </a>
                        <span class="ss">
                            &nbsp;&nbsp;&nbsp;
                            {% if entry.part_of_speech.slug != "letter" and entry.part_of_speech.slug != "number" %}
                                <i>{{ entry.part_of_speech.tag }}</i>
                            {% endif %}
                            {% if entry.homonym_gloss %}
                                {{ space }}
                                <span class="caps">{{ entry.homonym_gloss }}</span>
                            {% endif %}
                        </span>
                {% else %}
                    </a>
                {% endif %}
                </td>

                <td class="eli-author">

                    {% if entry.editor %}
                        <span class="ss">{{ entry.editor }}</span>
                    {% else %}
                        <span class="ssn">&lt; Автор не назначен &gt;</span>
                    {% endif %}
                </td>

                <td class="eli-mtime">
                    <span class="ss">
                        {{ entry.mtime|date("d.m.Y, H:i") }}
                    </span>
                </td>

                <td class="eli-status">
                    <span class="ss">{{ entry.status.tag }}</span>
                </td>

            </tr>
        {% endfor %}

            <tr class="entry-list-item last">

                <td class="eli-control first">
                    <div class="shade">
                        <div class="center"></div>
                        <div class="left"></div>
                        <div class="right"></div>
                    </div>
                </td>

                <td class="eli-control"></td>
                <td class="eli-entry"></td>
                <td class="eli-author"></td>
                <td class="eli-mtime"></td>
                <td class="eli-status"></td>

            </tr>

        </table>
    {% endif %}

    {% include '_pagination.html' %}
    {% endtrim %}
{% endblock %}
{% block javascript %}
    <script type="text/javascript">

        ko.observable.fn['objList'] = function(objList){
            this.list = ko.observableArray(objList);
            this.obj = ko.computed(function(){ return this.index2obj(this()); }, this);
            return this;
        };
        ko.observable.fn['index2obj'] = function(value){
            var representer = function(item){ return item.id; },
                arr = ko.utils.arrayMap(this.list(), representer),
                index = ko.utils.arrayIndexOf(arr, value);
            if (index < 0) throw new Error('Элемент в массиве не найден.');
            return this.list()[index];
        };

        var vM; if (!vM) vM = {};

        vM.filters = {
            form: vM.hdrSearch.form,
            sortdir: ko.observable('{{ filters.sortdir }}'),
            sortbase: ko.observable('{{ filters.sortbase }}'),
            find: ko.observable('{{ filters.find }}'),
            author: ko.observable('{{ filters.author }}').objList({{ viewmodel.authors }}),
            status: ko.observable('{{ filters.status }}').objList({{ viewmodel.statuses }})
        };


        vM.filters.sort = ko.computed({
            read: function(){
                return this.sortdir() + this.sortbase();
            },
            write: function(value){
                if (value.charAt(0) === '-') {
                    this.sortdir('-');
                    this.sortbase(value.slice(1));
                } else {
                    this.sortdir('');
                    this.sortbase(value);
                }
            },
            owner: vM.filters
        });

        vM.filters.doSort = function(sort){
            this.sort(sort);
            this.form.submit();
        };

        $('#id_find').attr('data-bind',
                'value: find,' +
                'valueUpdate: "afterkeydown"');
        $('#id_author').attr('data-bind',
                'options: author.list,' +
                'value: author,' +
                'optionsText: "name",' +
                'optionsValue: "id"');
        $('#id_status').attr('data-bind',
                'options: status.list,' +
                'value: status,' +
                'optionsText: "name",' +
                'optionsValue: "id"');

        ko.applyBindings(vM.filters, $('.filters').get(0));
        ko.applyBindings(vM.filters, $('#main').get(0));

        $('.f5sA--label').click(function(){
            $('.f5s--dashboard').slideToggle();
        });

        $('tr').mouseover(function(){
            $(this).addClass('hover');
        }).mouseout(function(){
            $(this).removeClass('hover');
        });

        $('.icon').mouseover(function(){
            $(this).next('.hint-container').show();
        }).mouseout(function(){
            $(this).next('.hint-container').hide();
        });
    </script>
{% endblock %}
