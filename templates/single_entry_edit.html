{% extends 'base--hdrSearch.html' %}

{% block content %}
<div class="curtain"></div>

<div class="grid edit"
     ondblclick="
         var x = $(this);
         if (x.hasClass('grid-debug'))
             x.removeClass('grid-debug');
         else
             x.addClass('grid-debug');
     ">

    <div class="message antconsol" data-bind="text: data.entry.antconc_query,
        visible: data.entry.antconc_query"></div>

    <span data-bind="wax: ui.entry.headword, waxCss: 'headword cslav'"></span>
    <i data-bind="text: ui.entry.part_of_speech"></i>

    <div style="margin: 30px 0;">

        <label>Заглавное слово</label>
        <input type="text" data-bind="value: ui.entry.headword,
            valueUpdate: 'afterkeydown'"/>
        <br/><br/>

        <label>Автор</label>
        <select data-bind="options: ui.choices.author,
            value: data.entry.author_ids, optionsText: 'name',
            optionsValue: 'id'">
        </select>
        <br/><br/>

        <label>Статус статьи</label>
        <select data-bind="options: ui.choices.entry_status,
            value: data.entry.status, optionsText: 'name',
            optionsValue: 'id'">
        </select>
        <br/><br/>

        <label>Примечание</label>
        <textarea data-bind="value: data.entry.additional_info,
            valueUpdate: 'afterkeydown'"></textarea>

    </div>

    {% trim %}
    {% include '_entryEdit_tabs.html' %}
    {% endtrim %}

    <input type="button" value="Закончить редактирование"
        data-bind="click: ui.saveDialogue.show" />

    <input type="button" value="undo"
        data-bind="click: undoStorage.undo,
                   disable: undoStorage.shouldDisableUndo" />

    <input type="button" value="redo"
        data-bind="click: undoStorage.redo,
                   disable: undoStorage.shouldDisableRedo" />

    <div class="modalContainer" style="display: none;"
        data-bind="visible: Meaning.itemBeingEdited">
        <div class="modalBackground"></div>
        <div class="modal"
            data-bind="template: {
                            name: 'editMeaning',
                            data: Meaning.itemBeingEdited,
                            if: Meaning.itemBeingEdited }"></div>
    </div>

    <div class="modalContainer" style="display: none;"
        data-bind="visible: ui.saveDialogue.active">
        <div class="modalBackground"></div>
        <div class="modal"
            data-bind="template: {
                            name: 'saveDialogue',
                            if: ui.saveDialogue.active }"></div>
    </div>

</div>


{% endblock %}


{% block javascript_links %}

    <script src="{{ STATIC_URL }}js/hdrSearch.js"
        type="application/javascript" charset="utf-8"></script>

    <script src="{{ STATIC_URL }}js/libs/ac2ucs8.js"
        type="text/javascript" charset="utf-8"></script>

    {% include '_script.knockout.postbox.html' %}

    {% include '_script.knockout.sortable.html' %}

    <script>

        vM.dataToInitialize = {
            entry: {{ entry }},
            choices: {{ choices }},
            labels: {{ labels }},
            slugs: {{ slugs }}
        };


        // Настройки knockout-sortable
        var placeholderClass = 'sortable-placeholder';
        ko.bindingHandlers.sortable.options = {
            appendTo: document.body,
            cursor: 'move',
            grid: [30, 1],
            placeholder: placeholderClass,
            start: function (event, ui) {
                var x = $(ui.item),
                    y = x.outerHeight();
                x.addClass('being-dragged');
                $('.' + placeholderClass).height(y);
            },
            stop: function (event, ui) {
                $(ui.item).removeClass('being-dragged');
            },
        };


        // Новый binding для отображения полуюникода в цсл виде
        // с различением слов и частей слова.
        var ac2ucs8 = antconc_ucs8,
            ac2cvlr = antconc_civilrus_word;
        ko.bindingHandlers.wax = {
            init: function (element, valueAccessor, allBindingsAccessor) {
                var value = valueAccessor(),
                    cssClasses = allBindingsAccessor().waxCss || 'cslav';
                value.wax = ko.computed(function () {
                        var word = value(),
                            isAffix = (word[0] === '-'),
                            dash = isAffix ? '<span>-</span>': '',
                            text = ('<span class="' + cssClasses + '">' +
                                    ac2ucs8(isAffix ? word.slice(1) : word, isAffix) +
                                    '</span>');
                            return dash + text;
                    });
                $(element).html(value.wax());
            },
            update: function (element, valueAccessor) {
                var value = valueAccessor();
                $(element).html(value.wax());
            }
        };

    </script>

    <script src="{{ STATIC_URL }}js/edit.js"
        type="application/javascript" charset="utf-8"></script>

{% endblock %}
