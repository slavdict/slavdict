<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>{{ title }}</title>
        <link href="{{ STATIC_URL }}style.css" rel="stylesheet" type="text/css">
        <link href="{{ STATIC_URL }}singlecomplete.css" rel="stylesheet" type="text/css">
    </head>
    <body>
        <noscript>Для правильной работы данной лексикографической системы необходимо, чтобы у Вас были включены скрипты.</noscript>

        {% block header_0 %}
        <div id="header">
            {% block header %}

                <a href="{% url my_entries_url %}">Мои статьи</a>
                <a href="{% url all_entries_url %}">Все статьи</a>
                <!--<a href="/" class="home permanent">&nbsp;&nbsp;&nbsp;</a>-->

                {% if user.is_admeditor %}
                    <a href="{% url admin:dictionary_entry_add %}" rel="prefetch">+</a>
                {% endif %}

                <form enctype="application/x-www-form-urlencoded" action="{% url all_entries_url %}">
                    <input type="text" name="find" value="{{ find_prefix }}"
                       class="singlecomplete--search"
                       data-bind="
                            value: searchPrefix,
                            valueUpdate: 'afterkeydown',
                            event: { keydown: navigateFoundItems }" />
                    <input type="submit" value="найти" />

                    <ul class="SC--foundItems" data-bind="foreach: foundItems">
                        <li class="SC--foundItem" data-bind="css: {'SC--foundItem-focused': isSelected }">
                            <span class="SC--fI--headword" data-bind="text: headword"></span>
                            <span class="SC--fI--homonym" data-bind="text: hom"></span>
                            <span class="SC--fI--pOS" data-bind="text: pos"></span>
                            <span class="SC--fI--hint" data-bind="text: hint"></span>
                        </li>
                    </ul>
                </form>

                <a href="{% url converter %}">Конвертър</a>

            {% endblock %}
        </div>
        {% endblock %}

        <div id="main">
            {% block content %}{% endblock %}
        </div>

        <script type='text/javascript' src='{{ STATIC_URL }}jquery-1.6.2.min.js'></script>
        <script type='text/javascript' src='{{ STATIC_URL }}knockout-latest.js'></script>
        <script>

            function Item(item, selected) {

                this.headword = item.headword;
                this.hom = item.hom || '';
                this.pos = item.pos || '';
                this.hint = item.hint || '';
                this.url = item.url;

                this.selectMe = function(){
                    selected(this);
                }.bind(this);

                this.isSelected = ko.dependentObservable(
                    function(){ return selected() === this; },
                    this
                );
            }

            var viewModel = {
                searchPrefix: ko.observable(),
                foundItems: ko.observableArray(),
                focusedItem: ko.observable(),

                moveFocusDown: function() {
//                    var arrLength = this.foundItems().length;
//                    var currentItem = this.focusedItem();
//                    var index = 0;
//                    if (currentItem) {
//                        index = ko.utils.arrayIndexOf(this.foundItems, currentItem);
//                        index = index > (arrLength - 2) ? 0 : ++index;
//                    }
//                    this.foundItems[index].selectMe();
                }.bind(this),
                moveFocusUp: function() {
                }.bind(this),
                go: function(item) {
                    window.location.href = item.url;
                },
                navigateFoundItems: function(event) {
                    if (this.foundItems()) {
                        if (event.which == 40) { // down arrow key
                            this.moveFocusDown();
                        } else if (event.which == 38) { // up arrow key
                            this.moveFocusUp();
                        } else if (event.which == 13) { // enter key
                            if (this.focusedItem()) this.go(this.focusedItem());
                        } else {
                            return true;
                        }
                    } else return true;
                }
            };

            ko.dependentObservable(function() {
                var dataToSend, searchPrefix = this.searchPrefix();
                if (this.lastItemsRequest) this.lastItemsRequest.abort();
                if (searchPrefix) {
                    dataToSend = { find: searchPrefix };
                    this.lastItemsRequest = $.getJSON(
                        "/json/singleselect/entries/urls/",
                        dataToSend,
                        function(data){
                            var mappedData = ko.utils.arrayMap(
                                data,
                                function(item){ return new Item(item, viewModel.focusedItem); }
                            );
                            viewModel.foundItems(mappedData);
                        }
                    );
                } else {
                    viewModel.foundItems.splice(0);
                }
            }, viewModel);

            ko.applyBindings(viewModel);
        </script>

        {% block javascript %}{% endblock %}

    </body>
</html>
