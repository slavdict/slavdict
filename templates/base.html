<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>{{ title }}</title>
        <link href="{{ STATIC_URL }}style.css" rel="stylesheet" type="text/css">
        <link href="{{ STATIC_URL }}singlecomplete.css" rel="stylesheet" type="text/css">
    </head>
    <body>
        <noscript>Для правильной работы данной лексикографической системы необходимо, чтобы у Вас были включены скрипты.</noscript>

        {% block header_0 %}
        <div class="header">
            {% block header %}

                <a href="{% url my_entries_url %}" class="header--item button">Мои статьи</a>
                <a href="{% url all_entries_url %}" class="header--item button">Все статьи</a>

                {% if user.is_admeditor %}
                    <a href="{% url admin:dictionary_entry_add %}" class="header--item button">+</a>
                {% endif %}


                <form class="searchForm" enctype="application/x-www-form-urlencoded" action="{% url all_entries_url %}">
                    <input type="text" name="find" class="header--item-left header--item-block search"
                       data-bind="
                            value: search.searchPrefix,
                            valueUpdate: 'afterkeydown',
                            event: { keydown: search.navigateFoundItems, blur: search.flushItems }"
                       autocomplete="off"
                       spellcheck="false"
                    /><span class="header--item-right button"
                            data-bind="click: function(){ $('form.searchForm').submit(); }">Найти</span>

                    <ul class="foundItems" data-bind="foreach: search.foundItems,
                                                      css: { hidden: search.foundItems().length == 0 }">
                        <li class="SC--foundItem"
                            data-bind="css: { 'SC--foundItem-focused': isFocused },
                                       event: {
                                            mousedown: function(){ $root.search.go($data); },
                                            mouseover: function(){ $data.focusMe(); }
                                       }">
                            <span class="SC--fI--headword" data-bind="text: headword"></span>
                            <span class="SC--fI--homonym" data-bind="text: hom"></span>
                            <span class="SC--fI--pOS" data-bind="text: pos"></span>
                            <span class="SC--fI--hint" data-bind="text: hint"></span>
                        </li>
                    </ul>
                </form>


                <a href="{% url converter %}" class="header--item button">Конвертър</a>

                {% if user.is_admeditor or user.is_hellinist %}
                    <a href="{% url hellinist_workbench %}" class="header--item button">Греческий кабинет</a>
                {% endif %}

                <span class="right-justification">
                    <a href="https://docs.google.com/document/d/1F2vnJpp_J48X49tdwrqefmtNd7wJIiAbuExp5TgZuwE/view?hl=en_US"
                       class="header--item button">Инструкция</a>
                </span>
            {% endblock %}
        </div>
        {% endblock %}

        <div id="main">
            {% block content %}{% endblock %}
        </div>

        <script type='text/javascript' src='{{ STATIC_URL }}jquery-1.7.1.min.js'></script>
        <script type='text/javascript' src='{{ STATIC_URL }}knockout-2.0.0.js'></script>
        <script>

            function Item(item, focused) {

                this.headword = item.headword;
                this.hom = item.hom || '';
                this.pos = item.pos || '';
                this.hint = item.hint || '';
                this.url = item.url;

                this.focusMe = function(){
                    focused(this);
                }.bind(this);

                this.isFocused = ko.dependentObservable(
                    function(){ return focused() === this; },
                    this
                );
            }

            var viewModel = {};

            viewModel.search = {
                searchPrefix: ko.observable( '{{ find_prefix }}' ),
                foundItems: ko.observableArray(),
                focusedItem: ko.observable()
            };

            viewModel.search.moveFocusDown = function() {
                var items = this.foundItems();
                var arrLength = items.length;
                var currentItem = this.focusedItem();
                var index = 0;
                if (currentItem) {
                    index = ko.utils.arrayIndexOf(items, currentItem);
                    index = index > (arrLength - 2) ? 0 : ++index;
                }
                items[index].focusMe();
            }.bind(viewModel.search);

            viewModel.search.moveFocusUp = function() {
                var items = this.foundItems();
                var arrLength = items.length;
                var currentItem = this.focusedItem();
                var index = arrLength - 1;
                if (currentItem) {
                    index = ko.utils.arrayIndexOf(items, currentItem);
                    index = index < 1 ? arrLength - 1 : --index;
                }
                items[index].focusMe();
            }.bind(viewModel.search);

            viewModel.search.go = function(item) {
                window.location.href = item.url;
            };

            viewModel.search.flushItems = function() { this.foundItems.splice(0); }.bind(viewModel.search);

            vM_hdrSearch.navigateFoundItems = function(vM, event) {
                if (event.which == 40) { // down arrow key
                    vM.moveFocusDown();
                } else if (event.which == 38) { // up arrow key
                    vM.moveFocusUp();
                } else if (event.which == 13) { // enter key
                    if (vM.focusedItem()) vM.go(vM.focusedItem());
                    else $('.header form').submit();
                } else if (event.which == 27) { // esc key
                    vM.foundItems.splice(0);
                } else {
                    return true;
                }
            };

            viewModel.search.searchPrefix.subscribe(function(newValue) {
                if (newValue) {
                    var dataToSend = { find: newValue };
                    if (this.lastItemsRequest) { this.lastItemsRequest.abort(); }
                    this.lastItemsRequest = $.getJSON(
                        "/json/singleselect/entries/urls/",
                        dataToSend,
                        function(data){
                            var mappedData = ko.utils.arrayMap(
                                data,
                                function(item){ return new Item(item, this.focusedItem); }.bind(this)
                            );

                            this.foundItems(mappedData);
                            if (this.foundItems().length==1) {
                                this.foundItems()[0].focusMe();
                            }
                        }.bind(this)
                    );
                } else {
                    this.flushItems();
                }
            }, viewModel.search);
        </script>

        {% block javascript %}{% endblock %}

        <script>
            ko.applyBindings(viewModel);
        </script>
    </body>
</html>
