{% extends 'base-flex.html' %}

{% block header %}
<div>

    <input type="button" data-bind="click: ui.saveDialogue.show"
        class="header--item button" value="Закончить редактирование" />

    {{ space }}
    <input type="button" class="header--item button"
        data-bind="
            click: undoStorage.undo,
            disable: undoStorage.shouldDisableUndo"
        value="↶" /><!-- или ⟲ -->

    {{ space }}
    <input type="button" class="header--item button"
        data-bind="
            click: undoStorage.redo,
            disable: undoStorage.shouldDisableRedo"
        value="↷" /><!-- или ⟳ -->

</div>

<aside>

    <input type="button" class="header--item button" id="copy_antconc_query"
        value="Запрос для AntConc" />

    {{ space }}
    <a href="http://ruscorpora.ru/search-orthlib.html"
       class="header--item button" target="_new">НКРЯ (цсл)</a>

    {{ space }}
    <a href="https://docs.google.com/document/d/1F2vnJpp_J48X49tdwrqefmtNd7wJIiAbuExp5TgZuwE/view?hl=en_US"
       class="header--item button" target="_new">Инструкция</a>

</aside>

{% endblock %}

{% block content %}

    <div class="curtain"></div>

    <aside class="edit">

        <div id="aside--headword">
            <label>Заглавное слово</label>
            <input type="text" data-bind="value: ui.entry.headword,
                valueUpdate: 'afterkeydown'"/>
        </div>

        <div class="aside--note"
         data-bind="visible: !Meaning.itemBeingEdited()">
            <label>Примечание к статье</label>
            <textarea data-bind="value: data.entry.additional_info,
                valueUpdate: 'afterkeydown'"></textarea>
        </div>

        <div class="aside--note" data-bind="visible: Meaning.itemBeingEdited,
         with: Meaning.itemBeingEdited">
            <label>Примечание к значению</label>
            <textarea data-bind="value: additional_info,
                valueUpdate: 'afterkeydown'"></textarea>
        </div>

    </aside>

    <article class="edit">

        <header>
            <div data-bind="template: { name: 'entryAdvertisement',
                data: data.entry }" class="entryAdvertisement"
                id="eA--entry"></div>

            <canvas id="eA--separator" width="30" height="80"
                data-bind="visible: Collogroup.itemBeingEdited"></canvas>
            <script type="application/javascript">
                (function () {
                    var cnvs = document.getElementById('eA--separator'),
                        ctx = cnvs.getContext('2d');
                    ctx.shadowOffsetY = 5;
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = 'rgba(210, 146, 22, 0.8)';
                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.moveTo(0, -4)
                    ctx.lineTo(12, 42);
                    ctx.lineTo(0, 84);
                    ctx.lineTo(0, -4);
                    ctx.fill();
                 })();
            </script>

            <div data-bind="visible: Collogroup.itemBeingEdited"
                class="entryAdvertisement">
                <span class="eA--collocation"
                    data-bind="wax: Collogroup.itemBeingEdited.slug"></span>
            </div>
        </header>

        {% trim %}
        {% include '_entryEdit_breadCrumbs.html' %}
        {% include '_entryEdit_tabs.html' %}
        {% endtrim %}

        {% include '_template.editMeaning.html' %}
        {% include '_template.saveDialogue.html' %}
        {% include '_template.entryAdvertisement.html' %}

        <div class="modalContainer"
            data-bind="visible: ui.saveDialogue.active">
            <div class="modalBackground"></div>
            <div class="modal"
                data-bind="template: {
                                name: 'saveDialogue',
                                if: ui.saveDialogue.active }"></div>
        </div>

    </article>
{% endblock %}


{% block javascript_links %}

    <script src="{{ STATIC_URL }}js/libs/ac2ucs8.js"
        type="text/javascript" charset="utf-8"></script>

    {% include '_script.zeroClipboard.html' %}

    {% include '_script.knockout.postbox.html' %}

    {% include '_script.knockout.sortable.html' %}

    {% include '_script.opentip.html' %}

    <script>

        var vM = {};

        vM.dataToInitialize = {
            entry: {{ entry }},
            choices: {{ choices }},
            labels: {{ labels }},
            slugs: {{ slugs }}
        };

        vM.entryURL = '{{ entryURL }}';


        // Настройки knockout-sortable
        var placeholderClass = 'sortable-placeholder';
        ko.bindingHandlers.sortable.options = {
            appendTo: document.body,
            grid: [30, 1],
            placeholder: placeholderClass,
            start: function (event, ui) {
                var x = $(ui.item),
                    y = x.outerHeight();
                x.addClass('being-dragged');
                $('.' + placeholderClass).height(y);
            },
            stop: function (event, ui) {
                $(ui.item).removeClass('being-dragged');
            },
        };


        // Новый binding для отображения полуюникода в цсл виде
        // с различением слов и частей слова.
        var ac2ucs8 = antconc_ucs8,
            ac2cvlr = antconc_civilrus_word;
        ko.bindingHandlers.wax = {
            init: function (element, valueAccessor, allBindingsAccessor) {
                var value = valueAccessor(),
                    cssClasses = allBindingsAccessor().waxCss || 'cslav';
                value.wax = ko.computed(function () {
                        var word = value(),
                            isAffix = (word[0] === '-'),
                            dash = isAffix ? '<span>-</span>': '',
                            text = ('<span class="' + cssClasses + '">' +
                                    ac2ucs8(isAffix ? word.slice(1) : word, isAffix) +
                                    '</span>');
                            return dash + text;
                    });
                $(element).html(value.wax());
            },
            update: function (element, valueAccessor) {
                var value = valueAccessor();
                $(element).html(value.wax());
            }
        };

    </script>

    <script src="{{ STATIC_URL }}js/edit.js"
        type="application/javascript" charset="utf-8"></script>

{% endblock %}
