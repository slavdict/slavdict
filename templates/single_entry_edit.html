{% extends 'base--hdrSearch.html' %}

{% block header %}

    {{ super() }}
    {% if not intermed %}
        {{ space }}
        <a href="{% url switch_info_url %}"
           class="header--item{% if show_additional_info %} on{% endif %}">Инфо</a>
    {% endif %}

{% endblock %}


{% block content %}

    <span class="cslav headword" data-bind="text: ui.entry.headword"></span>
    <i data-bind="text: ui.entry.part_of_speech"></i>

    <div style="margin-bottom: 40px;">

        <label>Заглавное слово</label>
        <input data-bind="value: data.entry.orthvars()[0].idem,
            valueUpdate: 'afterkeydown'"/>

        <label>Автор</label>
        <select data-bind="options: ui.choices.editor,
            value: data.entry.editor_id, optionsText: 'name',
            optionsValue: 'id'">
        </select>

        <label>Статус статьи</label>
        <select data-bind="options: ui.choices.entry_status,
            value: data.entry.status, optionsText: 'name',
            optionsValue: 'id'">
        </select>

    </div>

    <nav class="tabs">
    <ul>
        <li><a href="#orthvars">Варианты</a></li>
        <li class="current"><a href="#info">Справочная инфо</a></li>
        <li><a href="#meanings">Значения</a></li>
        <li><a href="#examples">Примеры</a></li>
        <li><a href="#constructions">Конструкции</a></li>
    </ul>
    </nav>

    <section id="info" class="tabcontent current">

        <select data-bind="options: ui.choices.part_of_speech,
            value: data.entry.part_of_speech, optionsText: 'name',
            optionsValue: 'id'">
        </select>

        <div data-bind="visible:
            data.entry.part_of_speech() === ui.slugs.part_of_speech['noun'] ||
            data.entry.part_of_speech() === ui.slugs.part_of_speech['adjective']">
            <label>
                Неизменяемое
                <input type="checkbox"
                       data-bind="checked: data.entry.uninflected"/>
            </label>
        </div>

        <div data-bind="visible:
            data.entry.part_of_speech() === ui.slugs.part_of_speech['noun']">

            <label>
                Форма Р. падежа
                <input data-bind="value: data.entry.genitive"/>
            </label>

            <label>
                Род
                <select data-bind="options: ui.choices.gender,
                    value: data.entry.gender, optionsText: 'name',
                    optionsValue: 'id'">
                </select>
            </label>

            <label>
                Число
                <select data-bind="options: ui.choices.tantum,
                    value: data.entry.tantum, optionsText: 'name',
                    optionsValue: 'id'">
                </select>
            </label>

        </div>

    </section>

    <section id="orthvars" class="tabcontent">

        <ul data-bind="sortable: data.entry.orthvars">
            <li style="width: 300px; background-color: #ddd; margin-bottom: 5px;">
                <input type="button" value="&times;"
                    data-bind="click:
                        $root.ui.destroyOrthvar.bind(null, $data)"/>
                <input data-bind="value: idem, valueUpdate: 'afterkeydown'"/>
                <span class="cslav" data-bind="text: idem_ucs"></span>
            </li>
        </ul>

        <input type="button" value="Добавить вариант"
            data-bind="click: ui.addOrthvar"/>

    </section>

    <section id="meanings" class="tabcontent">
    </section>

    <section id="examples" class="tabcontent">
    </section>

    <section id="constructions" class="tabcontent">
    </section>

    <input type="button" value="Сохранить" data-bind="click: ui.save"
        style="margin-top: 150px;"/>

{% endblock %}


{% block javascript_links %}

    {% include '_script.knockout.mapping.html' %}

    <script src="{{ STATIC_URL }}js/libs/jquery-ui-1.9.2.sortable.min.js"
        type="text/javascript"></script>

    <script src="{{ STATIC_URL }}js/libs/knockout-sortable.min.js"
        type="text/javascript"></script>

    <script src="{{ STATIC_URL }}js/libs/ac2ucs8.js"
        type="text/javascript"></script>

{% endblock %}


{% block javascript %}

    {{ super() }}

    var Orthvar = function(options, entry) {
            this.idem = ko.observable(options.data && options.data.idem || '')
            this.idem_ucs = ko.computed(
                function(){ return ac2ucs8(this.idem(), false); },
                this
            );
            this.order = ko.observable();
            Orthvar.counter++;

            if (typeof options.data !== 'undefined') {
                this.entry_id = options.data.entry_id;
                this.id = options.data.id;
                this.order(options.data.order);
            } else {
                this.entry_id = entry.id;
                this.id = 'orthvar' + Orthvar.counter;
                this.order(Orthvar.largestOrder + 1);
            }

            if (Orthvar.largestOrder < this.order()) {
                Orthvar.largestOrder = this.order();
            }
        },

        mapping = {
            orthvars: {
                create: function(options){ return new Orthvar(options); }
            }
        },

        ac2ucs8 = antconc_ucs8,
        ac2cvlr = antconc_civilrus_word,
        data = {{ entry }};

    Orthvar.counter = 0;
    Orthvar.largestOrder = 0;

    ko.mapping.defaultOptions().ignore.splice(0, 0, 'idem_ucs');

    ko.bindingHandlers.sortable.options = {
        axis: 'y',
        cursor: 'move',
        placeholder: 'ui-state-highlight',
        tolerance: 'pointer'
    };

    ko.bindingHandlers.sortable.afterMove = function(arg) {
        var i, j, arr = arg.targetParent();
        for (i=0, j=arr.length; i<j; i++) {
            arr[i].order(i);
        }
    };



    vM.entryEdit = {
        data: ko.mapping.fromJS(data, mapping),
        ui: {
            entry: {},
            choices: {{ choices }},
            labels: {{ labels }},
            slugs: {{ slugs }}
        }
    };

    var viewModel = vM.entryEdit,
        dataModel = viewModel.data,
        uiModel = viewModel.ui,
        dataEntry = dataModel.entry,
        uiEntry = uiModel.entry;



    uiEntry.headword = ko.computed(function(){
        return ac2ucs8(this.orthvars()[0].idem(), false)
    }, dataEntry);

    uiEntry.part_of_speech = ko.computed(function(){
        var x = this.data.entry.part_of_speech(),
            y = this.ui.labels.part_of_speech;
        if (x in y) {
            return y[x];
        } else {
            console.log('Часть речи "', x, '" не найдена среди ', y);
            return '';
        }
    }, viewModel);

    uiModel.save = function() {
        $.post('/entries/save/', {data: ko.mapping.toJSON(dataModel, mapping)});
    };

    uiModel.addOrthvar = function() {
        this.orthvars.push(new Orthvar({}, this));
    }.bind(dataEntry);

    uiModel.destroyOrthvar = function(orthvar) {
        if (typeof orthvar.id === 'number') {
            this.orthvars.destroy(orthvar);
        } else {
            this.orthvars.remove(orthvar);
        }
    }.bind(dataEntry);

    ko.applyBindings(viewModel, $('#main').get(0));

    $('nav.tabs li').click(function(){
        $('nav.tabs li.current').removeClass('current');
        $('section.tabcontent.current').removeClass('current');
        var x = $(this);
        x.addClass('current');
        $(x.find('a').attr('href')).addClass('current');
    });

{% endblock %}
