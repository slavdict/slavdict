<!DOCTYPE html>
<html>
<head>
    <title>Мультиселект</title>
    <link href="{{ STATIC_URL }}style.css" rel="stylesheet" type="text/css">
</head>
<body>
    <style>
.multiselect {
    width: 200px;
    min-height: 25px;
    background-color: #ccc;
    -moz-border-radius: 4px;
    -webkit-border-radius: 4px;
    border-radius: 4px;
    padding: 2px 7px;
    line-height: 25px;
}
.option {
    min-height: 20px;
    background-color: #fff;
    -webkit-border-radius: 4px;
    -moz-border-radius: 4px;
    border-radius: 4px;
    padding: 0 4px;
    white-space: nowrap;
}
.x {
    background-color: #a00;
    -webkit-border-radius: 7px;
    -moz-border-radius: 7px;
    border-radius: 7px;
    color: #fff;
    line-height: 12px;
    font-family: sans;
    font-size: 10px;
    cursor: pointer;
}
.multiselect input {
    width: 180px;
    border-width: 0;
    background-color: #ccc;
    font-family: Verdana;
    font-size: 12px;
    color: #777;
    outline-width: 0;
}
.multiselect input.empty {
    font-size: 11px;
    font-style: italic;
    color: #999;
}
.msList {
    position: absolute;
    top: 30px;
    width: 180px;
    max-height: 180px;
    padding: 0;
}
.msList ul {
    margin: 0;
    padding: 0;
}
.msList li {
    list-style-type: none;
    width: 140px;
    display: block;
    margin: 0;
    padding: 0 4px;
    border: 1px solid #ccc;
    background-color: #fff;
}
.msList li.focused {
    background-color: #777;
    color: #fff;
}
.hidden { display: none; }
    </style>

<form action="" method="get">
    <select multiple="multiple"
            name="entries" class="hidden"
            data-bind="selectedOptionsWithTemplate: selectedItems">
    </select>
    <input type="submit" />
</form>

    <table>
        <tr>
            <td style="position: relative;">
                <input type="text" placeholder="..."
                       data-bind="value: searchPrefix, valueUpdate: 'afterkeydown',
                                  event: { keydown: navigateFoundItems }, hasFocus: inputing"
                />
                <div class="msList">
                    <ul data-bind="template: {name: 'foundItemsTemplate', foreach: foundItems}"></ul>
                </div>
            </td>
            <td>
                <div class="multiselect"
                     data-bind="template: {name: 'selectedItemsTemplate', foreach: selectedItems}"></div>
            </td>
        </tr>
    </table>

    Having followed the MVVM pattern and got an object-oriented representation of the UI's data and behaviors, you're in
    a great position to sprinkle on extra behaviors in a very natural and convenient way.

    For example, if you're asked to display the total number of seats being reserved, you can implement that in just a
    single place, and you don't have to write any extra code to make the seat count update when you add or remove items.
    Just update the at the top of your view:

    <script type="text/x-jquery-tmpl" id="selectedItemsTemplate">
        <span class="option">
            <span class="cslav" data-bind="text: entry"></span>
            <span class="hom" data-bind="text: hom"></span>
            <span class="pos ss" data-bind="text: pos"></span>
            <span class="hint ss caps" data-bind="text: hint"></span>
            <span class="x" data-bind="click: function(){ viewModel.deselectItem($data); }">&times;</span></span>&#32;
    </script>

    <script type="text/x-jquery-tmpl" id="foundItemsTemplate">
        <li data-bind="css: { focused: $data.index == viewModel.focusedIndex() },
                       event: { mouseover: function(){ viewModel.focusedIndex($data.index); } },
                       click: function(){ viewModel.selectItem($data); }">
            <span class="cslav" data-bind="text: entry"></span>
            <span class="hom" data-bind="text: hom"></span>
            <span class="pos ss" data-bind="text: pos"></span>
            <span class="hint ss caps" data-bind="text: hint"></span>
        </li>
    </script>


    <script type='text/javascript' src='{{ STATIC_URL }}jquery-1.6.2.min.js'></script>
    <script type='text/javascript' src='{{ STATIC_URL }}jquery.tmpl.min.js'></script>
    <script type='text/javascript' src='{{ STATIC_URL }}knockout-1.2.1.js'></script>
    <script>

        ko.bindingHandlers.hasFocus = {
            init: function(element, valueAccessor) {
                $(element).focus(function() {
                    var value = valueAccessor();
                    value(true);
                });
                $(element).blur(function() {
                    var value = valueAccessor();
                    value(false);
                });
            },
            update: function(element, valueAccessor) {
                var value = valueAccessor();
                if (ko.utils.unwrapObservable(value))
                    element.focus();
                else
                    element.blur();
            }
        };

        ko.bindingHandlers.selectedOptionsWithTemplate = {
            init: function(element, valueAccessor) {
                var list = valueAccessor();
                $(element).find('option:selected').each(function(){
                    var x = $(this);
                    var val = x.val();
                    var txt = $.trim(x.text()).split(" ");
                    var item = {
                        pk: val,
                        civil: txt[0],
                        entry: txt[1].replace(/^\((.+)\)$/, "$1"),
                        hom: (txt.length > 2) ? txt[2] : "",
                        pos: (txt.length > 3) ? txt[3] : "",
                        hint: (txt.length > 4) ? txt[4] : ""
                    };
                    list.push(item);
                });
            },
            update: function(element, valueAccessor) {
                var list = ko.utils.unwrapObservable(valueAccessor());
                $(element).contents().remove();
                $.tmpl('<option selected="selected" value="${pk}">${civil} (${entry}) ${hom} ${pos} ${hint}</option>', list)
                    .appendTo(element);
            }
        };

        var viewModel = {

            searchPrefix: ko.observable(),
            inputing: ko.observable(),
            items: ko.observableArray(),
            foundItems: ko.observableArray(),
            selectedItems: ko.observableArray(),
            focusedIndex: ko.observable(-1),

            selectItem: function(item) {
                this.selectedItems.push(item);
                this.foundItems.splice(0);
                this.focusedIndex(-1);
                this.searchPrefix('');
                this.inputing(true);
            },
            deselectItem: function(item) {
                this.selectedItems.remove(item);
                this.inputing(true);
            },
            moveFocusDown: function() {
                var fi = this.focusedIndex();
                this.focusedIndex(fi < this.foundItems().length - 1 ? fi + 1 : 0);
            },
            moveFocusUp: function() {
                var fi = this.focusedIndex();
                this.focusedIndex(fi < 1 ? this.foundItems().length - 1 : fi - 1);
            },
            navigateFoundItems: function(event){
                if (this.foundItems()) {
                    if (event.which == 40) { // down arrow key
                        this.moveFocusDown();
                    } else if (event.which == 38) { // up arrow key
                        this.moveFocusUp();
                    } else if (event.which == 13) { // enter key
                        if (this.focusedItem()) this.selectItem(this.focusedItem());
                    } else {
                        return true;
                    }
                } else return true;
            }
        };

        viewModel.selectedIds = ko.dependentObservable(function(){
            var result = [];
            ko.utils.arrayForEach(this.selectedItems(), function(item) { result.push(item.pk); });
            return result;
        }, viewModel);

        viewModel.focusedItem = ko.dependentObservable(function(){
            return (this.focusedIndex() > -1) ? this.foundItems()[this.focusedIndex()] : null;
        }, viewModel);

        ko.dependentObservable(function() {
            var dataToSend, receivedData = [];
            if (this.lastItemsRequest) this.lastItemsRequest.abort();
            if (this.searchPrefix()) {
                dataToSend = { find: this.searchPrefix() };
                if (this.selectedIds().length) dataToSend.ids = this.selectedIds();
                this.lastItemsRequest = $.get("/json/entries/", dataToSend, this.foundItems);
            } else {
                this.foundItems.splice(0);
            }
        }, viewModel);

        ko.applyBindings(viewModel);
    </script>

</body>
</html>
