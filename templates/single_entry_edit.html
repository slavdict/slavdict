{% extends 'base--hdrSearch.html' %}

{% block header %}

    {{ super() }}
    {% if not intermed %}
        {{ space }}
        <a href="{% url switch_info_url %}"
           class="header--item{% if show_additional_info %} on{% endif %}">Инфо</a>
    {% endif %}

{% endblock %}


{% block content %}

    <span class="cslav headword" data-bind="text: ui.entry.headword"></span>
    <i data-bind="text: ui.entry.part_of_speech"></i>

    <div style="margin-bottom: 40px;">

        <label>Заглавное слово</label>
        <input data-bind="value: data.entry.orthvars()[0].idem,
            valueUpdate: 'afterkeydown'"/>

        <label>Автор</label>
        <select data-bind="options: ui.choices.editor,
            value: data.entry.editor_id, optionsText: 'name',
            optionsValue: 'id'">
        </select>

        <label>Статус статьи</label>
        <select data-bind="options: ui.choices.entry_status,
            value: data.entry.status, optionsText: 'name',
            optionsValue: 'id'">
        </select>

    </div>

    <nav class="tabs">
    <ul>
        <li><a href="#orthvars">Варианты</a></li>
        <li class="current"><a href="#info">Справочная инфо</a></li>
        <li><a href="#meanings">Значения</a></li>
        <li><a href="#examples">Примеры</a></li>
        <li><a href="#constructions">Конструкции</a></li>
    </ul>
    </nav>

    <section id="info" class="tabcontent current">


    </section>

    <section id="orthvars" class="tabcontent">

        <ul data-bind="sortable: data.entry.orthvars">
            <li style="width: 300px; background-color: #ddd; margin-bottom: 5px;">
                <input data-bind="value: idem, valueUpdate: 'afterkeydown'"/>
            </li>
        </ul>

        <input type="button" value="Добавить вариант"
            data-bind="click: ui.addOrthvar"/>

    </section>

    <section id="meanings" class="tabcontent">
    </section>

    <section id="examples" class="tabcontent">
    </section>

    <section id="constructions" class="tabcontent">
    </section>

    <input type="button" value="Сохранить" data-bind="click: ui.save"
        style="margin-top: 150px;"/>

{% endblock %}


{% block javascript_links %}

    {% include '_script.knockout.mapping.html' %}

    <script src="{{ STATIC_URL }}js/libs/jquery-ui-1.9.2.sortable.min.js"
        type="text/javascript"></script>

    <script src="{{ STATIC_URL }}js/libs/knockout-sortable.min.js"
        type="text/javascript"></script>

    <script src="{{ STATIC_URL }}js/libs/ac2ucs8.js"
        type="text/javascript"></script>

{% endblock %}


{% block javascript %}

    {{ super() }}

    ko.bindingHandlers.sortable.options = {
        axis: 'y',
        cursor: 'move',
        placeholder: 'ui-state-highlight',
        tolerance: 'pointer'
    };

    ko.bindingHandlers.sortable.afterMove = function(arg) {
        var i, j, arr = arg.targetParent();
        for (i=0, j=arr.length; i<j; i++) {
            arr[i].order(i);
        }
    };

    var data = {{ entry }},
        ac2ucs8 = antconc_ucs8,
        ac2cvlr = antconc_civilrus_word;

    vM.entryEdit = {
        data: ko.mapping.fromJS(data),
        ui: {
            entry: {},
            maps: {{ maps }},
            choices: {{ choices }}
        }
    };

    var viewModel = vM.entryEdit,
        dataModel = viewModel.data,
        uiModel = viewModel.ui,
        dataEntry = dataModel.entry,
        uiEntry = uiModel.entry,

        Orthvar = function(entry) {
            this.idem = ko.observable('');
            this.entry_id = entry.id;
            this.id = 'orthvar' + Orthvar.counter++;
            this.order = ko.observable(entry.orthvars.length);
        };

    Orthvar.counter = 1;

    uiEntry.headword = ko.computed(function(){
        return ac2ucs8(this.orthvars()[0].idem(), false)
    }, dataEntry);

    uiEntry.part_of_speech = ko.computed(function(){
        var x = this.data.entry.part_of_speech(),
            y = this.ui.maps.part_of_speech;
        if (x in y) {
            return y[x];
        } else {
            console.log('Часть речи "', x, '" не найдена среди ', y);
            return '';
        }
    }, viewModel);

    uiModel.save = function() {
        $.post('/entries/save/', {data: ko.mapping.toJSON(dataModel)});
    };

    uiModel.addOrthvar = function() {
        this.orthvars.push(new Orthvar(this));
    }.bind(dataEntry);

    ko.applyBindings(viewModel, $('#main').get(0));

    $('nav.tabs li').click(function(){
        $('nav.tabs li.current').removeClass('current');
        $('section.tabcontent.current').removeClass('current');
        var x = $(this);
        x.addClass('current');
        $(x.find('a').attr('href')).addClass('current');
    });

{% endblock %}
